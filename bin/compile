#!/usr/bin/env bash

# Get the desired version from the environment
MYSQL_BINARIES_VERSION=${MYSQL_BINARIES_VERSION:-0}

if [ $MYSQL_BINARIES_VERSION = "0" ]; then
   echo "-----> MySQL binaries could not be installed."
   echo "       MYSQL_BINARIES_VERSION not found in environment!"
   exit 1
fi


echo "-----> Installing MySQL $MYSQL_BINARIES_VERSION binaries"
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

mkdir -p $BUILD_DIR/.heroku/vendor
mkdir mysql-binaries

echo "       Downloading binary files..."

curl -L https://github.com/musa11971/heroku-buildpack-mysql-binaries/releases/download/0.0/${MYSQL_BINARIES_VERSION}.tar.gz | tar zxv -C mysql-binaries --strip-components=1
cp -R mysql-binaries/ $BUILD_DIR/.heroku/vendor/mysql-binaries/

echo "       Writing export file in $BP_DIR..."

echo "export PATH=\"\$PATH:$BUILD_DIR/.heroku/vendor/mysql-binaries/bin\"" > $BP_DIR/export
echo "export LD_LIBRARY_PATH=\"\$LIBRARY_PATH:$BUILD_DIR/.heroku/vendor/mysql-binaries/lib\"" >> $BP_DIR/export
echo "export LIBRARY_PATH=\"\$LIBRARY_PATH:$BUILD_DIR/.heroku/vendor/mysql-binaries/lib\"" >> $BP_DIR/export

echo "       Writing PATH to profile.d directory..."

mkdir -p $BUILD_DIR/.profile.d
echo "export PATH=\$HOME/.heroku/vendor/mysql-binaries/bin:\$PATH" > $BUILD_DIR/.profile.d/mysql-binaries.sh
echo "export LD_LIBRARY_PATH=\$LIBRARY_PATH:\$HOME/.heroku/vendor/mysql-binaries/lib" >> $BUILD_DIR/.profile.d/mysql-binaries.sh
echo "export LIBRARY_PATH=\$LIBRARY_PATH:\$HOME/.heroku/vendor/mysql-binaries/lib" >> $BUILD_DIR/.profile.d/mysql-binaries.sh